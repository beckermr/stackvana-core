{% set name = "stackvana-core-recipe" %}
# LSST DM versions are prefixed with letters
#
#  - a weekly build is 'w_2018_50'
#  - a major release is 'v18_1'
#
# In order to play nice with conda, we take the following conventions
#
#  - for a weekly build 'w_2018_50', the conda version is '2018.50w'
#  - for a major version 'v18_1', the conda version is '18.1.0'
#
# Note the exta micro version in order to match the tags in the DM eups system.
{% set version = "2020.40w" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

build:
  skip: true  # [win or py != 38]
  number: 1
  merge_build_host: True

requirements:
  host:
    - python
  run:
    - python

outputs:
  - name: stackvana-build
    version: {{ version }}
    requirements:
      run:
        - cmake
        - doxygen
        - flake8 >=3.8
        - make
        - pep8-naming
        - pip
        - psutil
        - pytest <6
        - pytest-cov
        - pytest-doctestplus !=0.7.0
        - pytest-flake8
        - pytest-openfiles
        - pytest-runner
        - pytest-session2file !=0.1.10
        - pytest-subtests
        - pytest-xdist
        - scons
        - sysroot_linux-64 =2.17  # [linux64]
        - curl

  - name: stackvana-core
    version: {{ version }}
    run_exports:
      - {{ pin_subpackage('stackvana-core-impl', exact=True) }}
    requirements:
      run:
        - {{ pin_subpackage('stackvana-core-impl', exact=True) }}

  - name: stackvana-core-impl
    version: {{ version }}
    script: build_impl.sh
    requirements:
      host:
        - python
        - pip
        - eups
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}

        # build dependencies
        - {{ pin_subpackage('stackvana-build', exact=True) }}
      run:
        - python
        - pip
        - eups

        # host-like and run-like
        # These are mostly run-like, but for the same reasons as
        # above, we need most of these at build time, so they are mostly
        # host-like
        - boost-cpp =1.70
        - cfitsio
        - eigen =3.3
        - eups
        - firefly-client
        - galsim =2
        - libaprutil =1
        - log4cxx
        - lsst-documenteer-pipelines
        - lsst-documenteer-technote
        - minuit2 =6
        - mpich
        - starlink-ast =9
        - wcslib =7
        - xpa =2
        - gsl

        # run-like
        - apr =1
        - autograd
        - astropy
        - backoff
        - boto3
        - bottleneck
        # conda is required for runtime inspection of installed software
        - conda
        - cffi =1
        - click >7
        - cython =0
        - deprecated
        - dustmaps
        - esutil
        - fastavro <0.24
        - future
        - git
        - git-lfs
        - h5py
        - healpy
        - healsparse
        - lmfit
        - lsstdesc.coord
        - matplotlib-base
        - mock =4.0.2
        - moto =1.3.14
        - mpi4py
        - ndarray =1
        - numexpr =2
        - numpy 1.17.*
        - pandas
        - pgcli
        - psycopg2 =2
        - pyarrow
        - pybind11 =2.5
        - pytables
        - pyyaml
        - requests
        - scikit-image
        - scikit-learn
        - scipy
        - seaborn
        - sqlalchemy
        - treecorr =4
        - ws4py
    test:
      script: run_test_impl.sh
      requires:
        - python
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ pin_subpackage('stackvana-build', exact=True) }}
        - cfitsio
        - curl
        - fftw
        - gsl
        - hdf5
        - hdf5 * mpi_mpich_*
        - libblas
        - libcblas
        - liblapack
        - liblapacke
        - log4cxx
        - mpich
        - numpy >=1.17

  - name: stackvana-afw
    version: {{ version }}
    script: build_afw.sh
    requirements:
      host:
        - python
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ pin_subpackage('stackvana-core', exact=True) }}
        - {{ pin_subpackage('stackvana-build', exact=True) }}
        - cfitsio
        - curl
        - fftw
        - gsl
        - hdf5
        - hdf5 * mpi_mpich_*
        - libblas
        - libcblas
        - liblapack
        - liblapacke
        - log4cxx
        - mpich
        - numpy 1.17.*
      run:
        - python
        - {{ pin_subpackage('stackvana-core', exact=True) }}
        - cfitsio
        - curl
        - fftw
        - gsl
        - hdf5
        - hdf5 * mpi_mpich_*
        - log4cxx
        - mpich
        - {{ pin_compatible('numpy') }}
    test:
      script: run_test_afw.sh


about:
  home: https://github.com/beckermr/stackvana-core
  license: GPL-3.0-or-later
  license_family: GPL
  license_file: LICENSE
  summary: 'core build tooling for stackvana'

extra:
  recipe-maintainers:
    - beckermr
